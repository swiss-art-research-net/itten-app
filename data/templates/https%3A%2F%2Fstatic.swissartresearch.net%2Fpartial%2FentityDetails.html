
<div class="jila-component panel-entity-details">
  <div class="container-fluid">
    <bs-row>
      <bs-col sm="12">
        <h2><mp-label iri="{{entityiri}}"></mp-label>
          {{#if initial}}
          {{else}}
              &nbsp;<semantic-link iri="page:viewEntity" urlqueryparam-entityiri="{{entityiri}}"><i title="Fokussieren" class="fa fa-dot-circle-o"></i></semantic-link>
          {{/if}}
        </h2>
      </bs-col>
    </bs-row>
    <bs-row>
      <bs-col md="8">
        [[> module-entity-description]]
      </bs-col>
      <bs-col md="4" class-name="image">
        <mp-resource-thumbnail iri="{{entityiri}}"></mp-resource-thumbnail>
      </bs-col>
    </bs-row>
  </div>
</div>
<div class="tabs">
  <bs-tabs>
    <bs-tab event-key="relations" title="Beziehungen">
      [[> component-relations-table]]
    </bs-tab>
    <bs-tab event-key="fields" title="Details">
      [[> component-fields-visualisation]]
      [[> component-source-link]]
    </bs-tab>
  </bs-tabs>
</div>

[[#*inline "component-fields-visualisation"]]
  <mp-field-visualization
    subject="{{entityiri}}"
    fields='[[> partial:fieldDefinitions]]'
    template='{{> field-table-template }}'
  >
      <template id="field-table-template">
          {{#if noData}}
              <div class="bs-alert">No data</div>
          {{else}}
              <div class="table-responsive rs-table">
                  <table class="table table-hover">
                      <thead>
                          <tr>
                              <th scope="col" style="width: 30%">Field</th>
                              <th scope="col">Value</th>
                          </tr>
                      </thead>
                      <tbody>
                      {{#each fields as |field|}}
                          {{#if field.values}}
                              <tr>
                                  <td>{{field.label.0.value}}</td>
                                  <td>
                                      {{#ifCond (objectLength field.values) '>' 1}}
                                          <ol>
                                              {{#each field.values as |value|}}
                                                  <li>
                                                      {{> field-value-template field=field value=value}}
                                                  </li>
                                              {{/each}}
                                          </ol>
                                      {{/ifCond}}

                                      {{#ifCond (objectLength field.values) '===' 1}}
                                          {{#each field.values as |value|}}
                                              {{> field-value-template field=field value=value}}
                                          {{/each}}
                                      {{/ifCond}}
                                  </td>
                              </tr>
                          {{/if}}                  
                      {{/each}}
                      </tbody>
                  </table>
              </div>
          {{/if}}
      </template>
      <template id="field-value-template">
          <div>
              {{#ifCond field.xsdDatatype.value "=="  "http://www.w3.org/2001/XMLSchema#string"}}
              {{value.value.value}}
              {{/ifCond}}
              {{#ifCond field.xsdDatatype.value "=="  "http://www.w3.org/2001/XMLSchema#langString"}}
              {{value.value.value}}{{#if value.value.language}} - {{value.value.language}}{{/if}}
              {{/ifCond}}
              {{#ifCond field.xsdDatatype.value "==" "http://www.w3.org/2001/XMLSchema#dateTime"}}
              {{value.value.value}}
              {{/ifCond}}
              {{#ifCond field.xsdDatatype.value "=="  "http://www.w3.org/2001/XMLSchema#anyURI"}}
              {{#if value.value.datatype}}
                  [[!-- in the messy data it can happen that field is anyURI but actual data is literal --]]
                  {{value.value.value}}
              {{else}}
                  <semantic-link class="external-link" iri="{{value.value.value}}"><mp-label iri="{{value.value.value}}"></mp-label></semantic-link>
              {{/if}}
              {{/ifCond}}
          </div>          
      </template>
  </mp-field-visualization>
[[/inline]]

[[#*inline "component-relations-table"]]
  <semantic-query
    query="SELECT 
        (GROUP_CONCAT(DISTINCT ?subject;SEPARATOR=';') as ?subjects) 
        (COUNT(DISTINCT ?subject) as ?num_subjects) 
        ?predicate 
        (GROUP_CONCAT(DISTINCT ?object;SEPARATOR=';') as ?objects) 
        (COUNT(DISTINCT ?object) as ?num_objects) 
      WHERE {
        BIND(<{{entityiri}}> AS ?subject)
        GRAPH <https://resource.swissartresearch.net/graph/network> {
          ?subject ?predicate ?object .
        }
        ?subject a ?typeSubject .
        ?object a ?typeObject .
        VALUES (?typeSubject) {
          [[> query-partial-entity-types]]
        }
        VALUES (?typeObject) {
          [[> query-partial-entity-types]]
        }

      } 
      GROUP BY ?predicate"
    template='{{> template-relations-table}}' 
  >
      <template id="template-relations-table">
        <table class="jila-component relations-table">
          <tbody>
            {{#each bindings}}
              <tr>
                <th><mp-label iri="{{predicate.value}}"></mp-label></th>
                <td>{{> template-split-entities entities=objects numEntities=num_objects.value}}</td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </template>

      <template id="template-split-entities">
        {{#ifCond numEntities ">" 3}}
          <details>
            <summary>
              <semantic-query
                query="SELECT DISTINCT ?type WHERE {
                  ?entity a ?type .
                  ?type rdfs:subClassOf* crm:E1_CRM_Entity .
                  VALUES (?entity) {
                    {{#each (split entities.value ';') }}
                      (<{{this}}>)
                    {{/each}}
                  }
                }"
                template="{{> template-types}}"
              >
                <template id="template-types">
                  <div>
                    {{#each bindings}}
                      <mp-label iri="{{type.value}}"></mp-label>{{#if @last}}{{else}}, {{/if}}
                    {{/each}} ({{numEntities}})
                  </div>
                </template>
              </semantic-query> 
            </summary>
            <semantic-table 
                id='grid-result'
                query='SELECT?subject ?label WHERE {
                    ?subject rdfs:label ?label
                    VALUES (?subject) {
                        {{#each (split entities.value ";")}}
                            (<{{this}}>)
                        {{/each}}
                    }
                } ORDER BY ?label'
                number-of-displayed-rows="10"
                options='{
                  {{#ifCond numEntities "<" 10}}
                    "showFilter": false,
                  {{/ifCond}}
                    "sorting": {"label": "asc"}
                }'
                tuple-template='{{> template-entity-tag subject=subject.value}}'
            >
              <template id="template-entity-tag">
                  <div class="jila-component entity-tag-row">
                      [[> template-entity-tag]]
                  </div>
              </template>
            </semantic-table>
          </details>
        {{else}}
          <ul class="jila-component entities-list">
          {{#each (split entities.value ";")}}
            <li>{{> template-entity-tag subject=this}}</li>
          {{/each}}
          </ul>
        {{/ifCond}}
      </template>

      <template id="template-entity-tag">
          [[> template-entity-tag]]
      </template>
    </semantic-query>
[[/inline]]

[[#*inline "component-source-link"]]
<div class="container-fluid">
  <bs-row>
    <bs-col sm="12">
      <semantic-link target="_blank" iri="{{entityiri}}">Quelldaten anzeigen <i class="fa fa-external-link"></i></semantic-link>
    </bs-col>
  </bs-row>
</div>
[[/inline]]

[[#*inline "module-entity-description"]]
  <semantic-query
  query="SELECT 
      ?description 
      ?dateOfBirth
      ?dateOfDeath
      ?placeOfBirth
      ?placeOfDeath
      (GROUP_CONCAT(?profession; SEPARATOR=',') as ?professions) 
    WHERE {
    BIND(<{{entityiri}}> as ?subject)
    OPTIONAL {
      ?subject crmdig:L54_is_same-as/gndo:professionOrOccupation ?profession .
    }
    OPTIONAL {
      ?subject crmdig:L54_is_same-as/gndo:biographicalOrHistoricalInformation ?description .
    }
    OPTIONAL {
      ?subject crmdig:L54_is_same-as/gndo:dateOfBirth ?dateOfBirth .
    }
    OPTIONAL {
      ?subject crmdig:L54_is_same-as/gndo:dateOfDeath ?dateOfDeath .
    }
    OPTIONAL {
      ?subject crmdig:L54_is_same-as/gndo:placeOfBirth ?placeOfBirth .
    }
    OPTIONAL {
      ?subject crmdig:L54_is_same-as/gndo:placeOfDeath ?placeOfDeath .
    }
  } GROUP BY 
  ?description 
  ?dateOfBirth
  ?dateOfDeath
  ?placeOfBirth
  ?placeOfDeath
  LIMIT 1"
  template="{{> template-description}}"
  >
  <template id="template-description">
    {{#each bindings}}
      {{#if dateOfBirth.value}}
        {{#if dateOfDeath.value}}
          <p>{{dateTimeFormat dateOfBirth.value "DD.MM.YYYY"}}{{#if placeOfBirth.value}} (<mp-label iri="{{placeOfBirth.value}}"></mp-label>){{/if}} - {{dateTimeFormat dateOfDeath.value "DD.MM.YYYY"}}{{#if placeOfDeath.value}} (<mp-label iri="{{placeOfDeath.value}}"></mp-label>){{/if}}</p>
        {{else}}
          <p>{{dateTimeFormat dateOfBirth.value "DD.MM.YYYY"}}{{#if placeOfBirth.value}} (<mp-label iri="{{placeOfBirth.value}}"></mp-label>){{/if}} - </p>
        {{/if}}
      {{else}}
        {{#if dateOfDeath.value}}
          - {{dateTimeFormat dateOfDeath.value "DD.MM.YYYY"}}{{#if placeOfDeath.value}} (<mp-label iri="{{placeOfDeath.value}}"></mp-label>){{/if}}
        {{/if}}
      {{/if}}
      {{#if professions.value}}
        <p>
          {{#each (split professions.value ',')}}
            <mp-label iri="{{this}}"></mp-label>{{#unless @last}}, {{/unless}}
          {{/each}}
        </p>
      {{/if}}
      {{#if description.value}}
        <p>{{description.value}}</p>
      {{/if}}
    {{/each}}
  </template>
  </semantic-query>
[[/inline]]

[[#*inline "template-entity-tag"]]
<semantic-query
    query='SELECT ?entity ?typeClass WHERE {
      BIND(<{{subject}}> AS ?entity)
      ?entity a ?type .
      VALUES(?type ?typeClass) {
        (crm:E21_Person "person")
        (crm:E39_Actor "actor")
        (crm:E5_Event "event")
        (crm:E22_Human-Made_Object "object")
        (crm:E53_Place "place")
        (crm:E78_Curated_Holding "collection")
      }
    } LIMIT 1'
    template="{{> template-tag-event-trigger}}">
      <template id="template-tag-event-trigger">
        <mp-event-trigger 
          id='node-click-{{bindings.0.entity.value}}'
          type="JILA.PanelNodeClicked"
          data='{"node": "{{bindings.0.entity.value}}"}'
        >
          <a href="#" class="jila-component tag {{bindings.0.typeClass.value}}">
            <mp-label iri="{{bindings.0.entity.value}}"></mp-label>
          </a>
      </mp-event-trigger>
      <mp-event-trigger 
        id='node-add-{{bindings.0.entity.value}}'
        type="JILA.PanelNodeAdd"
        data='{"node": "{{bindings.0.entity.value}}"}'
      >
        <div class="jila-component plus-button show-on-hover"><a href="#"><i class="fa fa-plus-circle" aria-hidden="true"></i></a></div>
    </mp-event-trigger>
    </template>
  </semantic-query>
  [[/inline]]

[[#*inline "query-partial-entity-types"]]
  (crm:E21_Person)
  (search:Actor)
  (search:Collection)
  (search:Event)
  (search:Object)
  (search:Person)
  (search:Place)
[[/inline]]